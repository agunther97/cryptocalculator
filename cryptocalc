#!/usr/bin/env python

import glob, os, code, sys

#set up helper func, list, etc
calculatorFunctions = {}
#structure:
#id:{
#   "name":"Readable Name",
#   "arguments_short":["x","y","z"],
#   "arguments":["arg1", "arg2", "arg3"],
#   "description":"Does something lol"
#}

indent="  "
lineCap=80

def fmtWrite(s, splitSearch):
    #this splits by line length 80 on commas
    buff=""
    while len(s)>0:
        p = s.find(splitSearch)
        if (p==-1):
            if (len(s)+len(buff))>lineCap:
                print(buff)
                print(s)
                buff=""
                s=""
            else:
                buff+=s
                s=""
        else:
            if (len(buff)+p)>lineCap:
                print(indent+buff)
                buff=""
            cut=p+3
            buff+=s[0:cut]
            s=s[cut:len(s)]
    if len(buff)>0:
        print(indent+buff)
def registerFunction(fn, data):
    calculatorFunctions[fn]=data
    
def displayFunctions():
    sz=len(calculatorFunctions.keys())
    funcList = [None for x in range(sz)]
    i=0
    for k,v in calculatorFunctions.items():
        funcList[i]=k
        i+=1
    funcList.sort()
    i=0
    s=""
    for f in funcList:
        s+=f+"("
        data = calculatorFunctions[f]
        args = None
        if "arguments_short" in data:
            args=data["arguments_short"]
        elif "arguments" in data:
            args=data["arguments"]

        if not (args is None):
            for j in range(len(args)):
                s=s+args[j]
                if j<len(args)-1:
                    s=s+","
            s=s+")"
            if (i<len(funcList)-1):
                s=s+", "
            i=i+1
    print("Registered Functions:")
    fmtWrite(s,"),")
    print("Use help(functionName) for more information.")

def displayFunction(fn):
    data=calculatorFunctions[fn]

    if "name" in data:
        print(data["name"])
    else:
        print(fn)
    args = []
    if "arguments" in data:
        args=data["arguments"]
    elif "arguments_short" in data:
        args=data["arguments_short"]
    s=indent+"Usage: " + fn + "("
    for j in range(len(args)):
        s=s+args[j]
        if j<len(args)-1:
            s=s+","
    s=s+")"
    fmtWrite(s," ")
    if "description" in data:
        fmtWrite(indent+data["description"], " ")



def help(*args):
    funcName=""
    for arg in args:
        if len(funcName)>0:
            funcName = funcName + " "
        if callable(arg):
            funcName = funcName + arg.__name__
        else:
            funcName = funcName + arg
    if (funcName==""):
        print("CryptoCalc")
        displayFunctions()
    else:
        displayFunction(funcName)

#load modules
os.chdir("./modules")

for file in glob.glob("*.py"):
	exec(open("./"+file).read())

os.chdir("../")

if(len(sys.argv) > 1):
    args = sys.argv
    args = args[1:]
    if args[0]=="-f" and not (args[1] is None):
        f = open(args[1])
        if (not (f is None)):
            exec(f.read())
        #execute file
    else:
        for arg in args:
            execute = arg + " "
        execute = execute[:-1]
        exec("print("+execute+")")
else:
    #enter interactive state
    code.interact(local=dict(globals(), **locals())) 
